\section{System Design}
\label{sec:fdsp-tpcelec-design}
\fixme{A brief introduction here would help with the logical development of the document.}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Grounding and Shielding}
\label{sec:fdsp-tpcelec-design-grounding}

\fixme{Needs input from ProtoDUNE studies; specifically, problems with external noises during ProtoDUNE commissioning, and remaining sources of noise that are being investigated}

To minimize system noise, the \dword{ce} cables for each \dword{apa} enter 
the cryostat through a single \dword{ce} flange, as shown in Figure~\ref{fig:connections}. This creates, for grounding purposes, an integrated unit consisting of an \dword{apa} frame, \dword{femb} ground for all \num{20} \dword{ce} modules, \dword{tpc} flange, and warm interface
electronics. To do this,
the input amplifiers on the \dword{fe} \dwords{asic} have their ground terminals connected to the \dword{apa} frame. 
All power-return leads and cable shields are connected to both the ground plane of the \dword{femb} and to the \dword{tpc} signal flange.

The only location where this integrated unit makes electrical contact with the 
cryostat, which defines \textit{detector ground}, is at a single point on the \dword{ce} \fdth board in the \dword{tpc} signal flange where the 
cables exit the cryostat. Mechanical suspension of the \dword{apa}s is accomplished using insulated supports. 
To avoid structural ground loops, the \dword{apa} frames described in Chapter~\ref{ch:fdsp-apa} are 
insulated from each other.

Filtering circuits for the \dword{apa} wire-bias voltages are locally referenced to the ground plane of the \dwords{femb} through low-impedance electrical connections. This approach ensures a ground-return path in close proximity to the bias-voltage and signal paths. The close proximity of the current paths minimizes the size of potential loops to further suppress noise pickup.

Signals associated with the \dword{pds}, described in Chapter~\ref{ch:fdsp-pd}, are carried directly on shielded, 
twisted-pair cables to the signal \fdth. The cable shields are connected to the cryostat 
at the \dword{pd} flange shown in Figure~\ref{fig:connections}, and to the \dword{pcb} shield layer on the \dwords{pd}. The cable shields have no electrical connection to the \dword{apa} frame.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Distribution of Bias Voltages}
\label{sec:fdsp-tpcelec-design-bias}

\fixme{We are going to try to minimize the overlap of this section with the corresponding section in the APA chapter to avoid repetition.  Refer to APA section and strictly discuss parts necessary to explain coupling between wires and readout that is done to minimize cross-talk.}

Each side of an \dword{apa} includes four wire layers, as described in Section~\ref{sec:fdsp-apa-design}. 
%The innermost X-plane layer of wires is nominally biased at +820~V, with each wire AC coupled 
%to one of the 128 charge amplifier circuits on the \dword{femb}. The V-plane wire layer is effectively biased at zero volts, 
%with each wire directly connected to one of the charge amplifier circuits. The U-plane wire layer is nominally 
%biased at $-$370~V with each wire AC-coupled 
%to one of the 128 charge amplifier circuits. The outermost G-plane wire layer,
%which has no connection to the charge amplifier circuits, is biased at $-$665~V.
Electrons passing through the wire grid must drift unimpeded until they reach the $X$-plane 
collection layer. The nominal bias voltages are predicted to result in this electrically 
transparent configuration and are given in Section~\ref{sec:fdsp-apa-design}. 

The filtering of wire bias voltages and \dword{ac} coupling of wire signals passing
onto the charge amplifier circuits is done on \dword{cr} boards that plug in between the \dword{apa} wire-board stacks and \dwords{femb}.
Each \dword{cr} board includes single RC filters for the $X$- and $U$-plane wire bias voltages. In addition, each board has \num{48} 
pairs of bias resistors and \dword{ac} coupling capacitors for $X$-plane wires, and \num{40} pairs for the $U$-plane wires. The coupling capacitors block DC while passing \dword{ac} 
signals to the \dword{ce} motherboards.  A schematic diagram of the \dword{pdsp} \dword{apa} wire bias subsystem is in Figure~\ref{fig:CR-board}.

\begin{dunefigure}
	[\dword{pdsp} \dword{apa} wire bias schematic diagram, including the \dword{cr} board.]
	{fig:CR-board}
	{\dword{pdsp} \dword{apa} wire bias schematic diagram including the \dword{cr} board.}
\includegraphics[width=0.8\linewidth]{sp-tpcelec-cr-board.pdf}
\end{dunefigure}

\fixme{Move Figure~\ref{fig:CR-board} to APA chapter, and replace with simplified picture focusing on wire cross-talk?}

%Separate \dword{cr} boards include a single R-C filter for the G-plane wires and 12 pairs of bias resistors and
%coupling capacitors.
%Groups of four wires are tied together to share single
%bias resistors and filter capacitors. These \dword{cr} boards do not connect to the charge amplifier circuits on the \dword{femb}.

Clamping diodes limit the input voltage received at the amplifier circuits to between \SI{1.8}{V}\,$\pm$\,U$_D$, where U$_D$
is the breakdown voltage of the diode, approximately \SI{0.7}{V}.
The amplifier circuit has a \SI{22}{nF} coupling capacitor at input to avoid leakage current from the protection clamping diodes. 

%%% UNCLEAR, REMOVE FOR NOW
%Coupling capacitors for the X-plane and U-plane wires are required to block DC bias voltages.
%However they also impact the efficiency of the detector circuits.
%The sense wires are expected to have $\sim200$~pF of capacitance to the \dword{apa} frame.
%Induced or collected charges are effectively divided between the wire capacitance and the coupling capacitor.
%To achieve a charge-calibration accuracy of 0.5 percent or better,
%the coupling capacitors must be 4.7\,nF at ten percent tolerance, or 2.2\,nF at five percent tolerance.
%Voltage ratings should be at least 1.5 times the expected operating voltages.

Bias resistance values should be at least \SI{20}{\mega\ohm} to maintain negligible noise contributions.
The higher value helps achieve a longer time constant for the high-pass coupling networks.
Time constants should be at least \num{25} times the electron drift time so that the undershoot in the digitized waveform
is small and easily correctable.
However, leakage currents can develop on PC \fixme{Does this abbreviation need to be in the glossary?} boards that are exposed to high voltages over extended periods.
If the bias resistors are much greater than \SI{50}{\mega\ohm}, leakage currents may affect the bias voltages applied to the wires. The target value of \SI{50}{\mega\ohm} was used in \dword{pdsp}.

The bias-voltage filters are RC low-pass networks.
Resistance values should be much smaller than the bias resistances to control cross-talk between wires
and limit the voltage drop if any of the wires becomes shorted to the \dword{apa} frame.
The value of \SI{2.2}{\mega\ohm} was used in \dword{pdsp}.
Smaller values may be considered for %DUNE 
the \dword{spmod} although a larger filter capacitor would be required to maintain a given level of noise reduction.
The target value of \SI{47}{nF} was used in \dword{pdsp} for the filter capacitors.

%For the grid-plane bias filters, component values are less critical.
%If possible they will be identical to those used for the bias resistors and coupling capacitors
%(50~M$\Omega$ and 2.2 to 4.7\,nF).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Front End Motherboard}
\label{sec:fdsp-tpcelec-design-femb}

\fixme{FEMB description needs to be dramatically expanded for the second draft of the TDR.  A lot of information is missing.}

\fixme{The text under 1.2.3.1 (Overview) could be used as the introduction to section 1.2.3 (Front End Motherboard.}
%%%%%%%%%%%%%%%%%%
\subsubsection{Overview}
\label{sec:fdsp-tpcelec-design-femb-overview}

Each \dword{apa} is instrumented with \num{20} \dwords{femb}.
The \dwords{femb} plug into the \dword{apa} \dword{cr} boards, making the connections from the wires to the charge amplifier circuits as short as possible.
Each \dword{femb} receives signals from \num{40} $U$ wires, \num{40} $V$ wires, and \num{48} $X$ wires.
The baseline \dword{femb} design contains eight \num{16}-channel \dword{fe} (\dword{larasic}) \dwords{asic}, eight \num{16}-channel Cold \dword{adc} \dwords{asic}, and two \dword{coldata} control and communication \dwords{asic} (see Figure~\ref{fig:ce-scheme}).
The \dword{femb} also contains regulators that produce the voltages required by the \dwords{asic} and 
filter those voltages.
The \dword{larasic} inputs are protected by diodes and a series inductor.

\begin{dunefigure}
[The baseline \dword{ce} architecture.]
{fig:ce-scheme}
{The baseline \dword{ce} architecture. The basic unit is the \num{128}-channel \dword{femb}. Note that only one \dword{ce} flange is shown to simplify the illustration. Note that \dword{ssp} stands for \textit{SiPM Signal Processor} (see Chapter~\ref{ch:fdsp-pd}).}
\includegraphics[width=0.9\linewidth,angle=90]{sp-tpcelec-schematic-v3.pdf}
\end{dunefigure}

The \dword{pdsp} version of the \dword{femb} (which uses a single \dword{fpga} on a mezzanine card instead of two \dword{coldata} \dwords{asic}) is shown in Figure~\ref{fig:femb}.

\begin{dunefigure}
[The complete \dword{femb} assembly as used in \dword{pdsp}.]
{fig:femb}
{The complete \dword{femb} assembly as used in the \dword{pdsp} detector. The cable shown is the high-speed data, clock, and control cable.}
\includegraphics[width=0.6\linewidth]{sp-tpcelec-femb.png}
\end{dunefigure}

%%%%%%%%%%%%%%%%%%
\subsubsection{Front End ASIC}
\label{sec:fdsp-tpcelec-design-femb-fe}

The analog \dword{fe} \dword{asic}~\cite{DeGeronimo:2011zz} receives current signals from the \dword{tpc} sense wires and provides a way to amplify and shape the signals for downstream signal digitization.  The \dword{fe} \dword{asic} has 16 channels and is implemented using the TSMC 180nm CMOS process. It integrates a band-gap reference (BGR) \fixme{This abbreviation is not in the glossary.} to generate all the internal bias voltages and currents. This guarantees high stability of the operating point over a wide range of temperatures, including cryogenic temperatures. The channel schematic of the \dword{fe} \dword{asic} is shown in Figure~\ref{fig:feasic1}. 

\begin{dunefigure}
[FE ASIC channel schematic]
{fig:feasic1}
{Channel schematic of FE ASIC, which includes a dual-stage charge amplifier and a 5$^{th}$ order semi-Gaussian shaper with complex conjugate poles. Circuits in red circles are programmable to allow different gain and peaking time settings.}
\includegraphics[width=0.99\linewidth]{sp-tpcelec-feasic-channelschematic.pdf}
\end{dunefigure}

Each \dword{fe} \dword{asic} channel has a dual-stage charge amplifier and a 5$^{th}$ order semi-Gaussian shaper as an anti-aliasing filter for the \dword{tpc} signals. It has a programmable gain selectable from one of 4.7, 7.8, 14, or 25mV/fC (corresponding to full-scale charge of 300, 180, 100, and 55 fC), a programmable peaking time selectable from one of 0.5, 1, 2, and 3 $\mu$s, and a programmable baseline for operation with either the collection ($\sim$200mV) or the induction ($\sim$900mV) wires. Each channel has an option to enable the output monitor to probe the analog signal, and an option to enable a high-performance output driver that can be used to drive a long cable. 

Each \dword{fe} \dword{asic} channel has a built-in charge calibration capacitor that can be enabled or disabled through a dedicated register. The injection capacitance has been measured using a calibrated external capacitor. The measurements show that the calibration capacitance is extremely stable, changing from 184 fF at room temperature to 183 fF at 77 K. This result and the measured stability of the peaking time demonstrate the high stability of the passive components as a function of temperature. Channel-to-channel and chip-to-chip variation in the calibration capacitor are typically less than 1\%.

Shared among the 16 channels in the \dword{fe} \dword{asic} are the digital interface, programming registers, a temperature monitor, and a band-gap reference monitor. We also can enable \dword{ac} coupling as mitigation of microphonics, a programmable bias current selectable from one of 0.1, 0.5, 1, or 5nA, as well as a programmable pulser generator with 6-bit \dword{dac} for calibration. 

The power dissipation of \dword{fe} \dword{asic} is about 5.5mW per channel at 1.8V supply voltage with output buffer disabled. The \dword{asic} is packaged in a commercial, fully encapsulated plastic QFP 80 package. Figure~\ref{fig:feasic2} shows the response of \dword{fe} \dword{asic} for all gains and peaking times and both baselines. Note that the gain is independent of the peaking time; the same amount of charge produces the same peak voltage signal regardless of the peaking time.

\begin{dunefigure}
[FE ASIC response and layout]
{fig:feasic2}
{Response of FE ASIC for four gains, four peaking times, and both baseline values (left); layout of 16-channel FE ASIC version P3, where revisions with reference to version P2 are highlighted in yellow boxes (right).}
\includegraphics[width=0.53\linewidth]{sp-tpcelec-feasic-response.pdf}
\hspace{6mm}
\includegraphics[width=0.42\linewidth]{sp-tpcelec-feasic-layout.pdf}
\end{dunefigure}

Prototype version P2 \dword{fe} \dwords{asic} have been evaluated and characterized at room temperature and LN$_2$ (77 K) temperature. 960 P2 \dword{fe} \dwords{asic}, totaling 15,360 channels, have been used to instrument six \dword{pdsp} \dword{apa}s successfully. Excessive stress of package of \dword{fe} \dword{asic} in cryogenic temperature means \dword{fe} channels have a non-uniform baseline in collection mode, while the baseline DC voltage in induction mode is uniform. A new prototype, version P3, was fabricated in March 2018 to address this issue by making DC circuits for collection mode similar to the induction mode. At the same time, the default gain setting changed to 14mV/fC. The layout of P3 \dword{fe} \dword{asic} is shown in Figure \ref{fig:feasic2}, with modifications highlighted in yellow boxes. The P3 \dword{fe} \dwords{asic} were received and evaluated in September 2018, and both baseline in collection mode and default gain setting are working properly.

P3 \dword{fe} \dword{asic} will be further evaluated on \dwords{femb} in various integration test stands for performance studies, including 40\% \dword{apa} at \dword{bnl}, \dword{iceberg} \dword{tpc} at \dword{fermilab} and \dword{apa}7 at CERN. Test results of P3 \dword{fe} \dword{asic} will guide the development of the next version P4 \dword{fe} \dword{asic}, which will be implemented single ended to differential (SE-DIFF) converter for interface to recently developed \dword{adc} \dword{asic}. During \dword{pdsp} operation, it was observed that the \dword{fe} \dwords{asic} may enter into a saturation mode when large amounts of charge ($>$ 50fC) collect in 10-50$\mu$s. This is being studied in the laboratory test stand, with the plan to address it in the P4 \dword{fe} \dword{asic} revision as well.

%%%%%%%%%%%%%%%%%%
\subsubsection{ADC ASIC}
\label{sec:fdsp-tpcelec-design-femb-adc}

\dword{coldadc} is a low-noise \dword{adc} \dword{asic} designed to digitize
16 input channels at a rate of \SI{2}{MHz}. It is implemented in the TSMC
\SI{65}{nm} \dword{cmos} technology and has been designed by a team of engineers
from LBL, \dword{bnl}, and \dword{fermilab}.  The \dword{asic} uses a conservative,
industry standard design including digital calibration.  Each \dword{coldadc}
receives 16 voltage outputs from a single \dword{larasic} chip.  The voltages
are buffered, multiplexed by 8, and input to two 15-stage pipelined \dwords{adc}
operating at \SI{16}{MHz}.  The \dword{adc} uses the well-known pipelined architecture
with redundancy~\cite{PipelinedADC}.  Digital logic is used to correct non-linearity
introduced by non-ideal amplifier gain and offsets in each pipeline
stage~\cite{CalibrationCorrection}, and an automatic calibration procedure is
implemented to determine the constants used in this logic.  The \dword{adc} produces
16-bit output which is expected to be truncated to 12 bits.

The \dword{adc} is highly programmable to optimize performance at different
temperatures.  In order to maximize the probability that the first prototype
\dword{coldadc} will perform well, many circuit blocks can be bypassed.  A block
diagram of the chip is shown in Figure~\ref{fig:COLDADC_Block_Diagram}.  Each of
the major blocks is described below.

\begin{dunefigure}[COLDADC block diagram]{fig:COLDADC_Block_Diagram}{COLDADC block diagram}
\includegraphics[width=1.0\linewidth]{sp-tpcelec-COLDADCblockdiagram.pdf}
\end{dunefigure}

All required reference voltages and currents are generated on-chip by programmable
circuit blocks.  The most accurate reference voltage circuit is a band-gap reference
based on a PNP (bipolar) transistor.  However, measurements made at \dword{bnl} and
LBL of a large PNP transistor indicate that the foundry-provided \dword{spice} model
does not adequately describe the device operation at liquid argon temperature.  Thus,
a \dword{cmos}-based voltage reference has also been included in \dword{coldadc}.
In the event that both on-chip reference generation circuits fail, an external voltage
reference can be used.

Independently adjustable bias voltage levels and currents are provided for the
input buffers, sample-and-hold amplifiers, \dwords{adc}, and \dword{adc}
reference buffers.

\dword{coldadc} has four possible ways to interface with \dword{larasic}.  It
can accept either single-ended inputs (provided by existing \dword{larasic}
chips) or differential inputs (foreseen for a future \dword{larasic} upgrade).
In either case, to mitigate the risk that the input buffer circuits do not perform
well, it is also possible to bypass the input buffers and apply the inputs directly
to the sample-and-hold amplifiers.  The sample-and-hold amplifiers are separated
into two groups of eight.  They sample the waveform at the rising edge of the
(\SI{2}{MHz}) sampling clock.  An internally generated \SI{16}{MHz} clock is then
used to clock an 8-to-1 multiplexer which presents 8 samples in turn to one of the
two \dword{adc} pipelines.

A block diagram of an \dword{adc} pipeline is shown in
Figure~\ref{fig:pipelinestage}. Each of the 15 stages contains a low-resolution
1.5-bit analog-to-digital subconverter (ADSC) containing two comparators, a
1.5-bit digital-to-analog subconverter (DASC) that produces an voltage based on
the two comparator outputs, an analog subtractor, a sample-and-hold amplifier
(SHA), and a gain stage (with a nominal gain of two). The transfer function of
each stage is identical and is shown in Figure~\ref{fig:ADCXFERFN} along with
the nominal ``weights'' (W0 and W2) that are added to form the output of the
pipeline. Each pipeline stage makes a three-level coarse decision based on the
analog input voltage, selects one of three digital ``weights'' to be added to the
results of previous stages, and passes a voltage to the next stage that is
proportional to the difference between the input voltage and the voltage
corresponding to the digital output of the stage.  Because the stages are
weighted by a factor of two, but have three possible digital results, there is
redundancy between stages that makes the final result independent of errors in
the comparator thresholds (up to $\pm{\frac{V_r}{4}}$ where the stage range is
$[-V_r,V_r]$).  An ``error'' in the output of one stage is corrected in subsequent
stages (usually the next stage).  In order to take advantage of this redundancy
provided by the pipelined architecture it is necessary to include at least one
``extra'' stage in the pipeline.  The \dword{coldadc} pipelined \dwords{adc} are
implemented as 15-stage pipelines.

\begin{dunefigure}[Circuit blocks in each \dword{adc} pipeline stage]{fig:pipelinestage}{Circuit blocks in each \dword{adc} pipeline stage}
\includegraphics[width=1.0\linewidth]{sp-tpcelec-Pipelinestage.pdf}
\end{dunefigure}

\begin{dunefigure}[ADC stage transfer function]{fig:ADCXFERFN}{1.5-bit stage transfer function and digital output. The voltage range of the \dword{adc} as a whole, and of each individual stage is $[-V_r,V_r]$.  Note that the voltage passed to the subsequent stage will not exceed the stage range even if a comparator threshold is wrong by up to $\frac{V_r}{4}$.}
\includegraphics[width=1.0\linewidth]{sp-tpcelec-ADCXFERFN.pdf}
\end{dunefigure}

The calibration logic allows the correction of errors caused by imperfections
in the voltage that is passed from one stage to the next.  These arise from
errors in the voltage in each stage corresponding to $\pm{V_{r}\over{2}}$
(generated by resistive dividers) and imperfections in the gain and offset of
the interstage amplifiers.  The calibration procedure relies on the fact that
the required precision is easily satisfied by the last stages of the pipeline.
The number of stages to be calibrated (maximum 7) is set by a programmable
register.  An iterative calibration procedure is used.  Starting with the least
significant stage to be calibrated, the input to the stage is set to the threshold
levels of $\pm{V_{r}\over{4}}$ and the normal comparator outputs are overridden
and forced first to 1 and then to 0.  The lower stages of the \dword{adc} digitize
the analog value output from the stage being calibrated and the difference between
the \dword{adc} output when the comparator is forced to 1 and the \dword{adc}
output when the comparator is forced to 0 is calculated.  These two differences
(W0 expressed as a negative number and W2 expressed as a positive number) are
stored and used as two of the three possible digital outputs of the stage being
calibrated (the third possible output being 0).  This procedure is then repeated
for the next most significant pipeline stage until stage 15 has been calibrated.

The main weakness of the 1.5-bit per stage pipeline architecture as presented
is that it requires a precise interstage gain of two.  If the gain is greater
than two, then when the input voltage to a stage is close enough to the limits
of the voltage range of the stage, the voltage passed to the next stage will be
out of range.  This will result in skipped \dword{adc} codes.  For this reason,
the interstage gain of \dword{coldadc} is designed to be $\sim1.998$.  The
calibration procedure recovers the linearity that would be lost due to
non-binary stage weighting.  A small number of \dword{adc} codes near two
extremes of the voltage range are unused \footnote{Simulations of \dword{coldadc}
  including layout parasitics indicate that $\sim150$ 16-bit codes will be
  unused at the extremes.}, but no skipped codes appear in the range of codes
used.  The number of \dword{adc} bits that are useful depends on the effective
noise of the various subcircuits of the \dword{adc}.  The noise of the first few
pipeline stages (associated with the most significant bits) contributes more
heavily than subsequent stages.  For this reason, the first stages are designed
to be larger, lower noise, and more power hungry than later stages.  The total
effective noise expected is \SI{\sim130}{$\mu$V}-rms.  This is similar to the
quantization error of an ideal 12-bit \dword{adc} with a voltage range of
\SI{1.5}{V} for which the bin width is \SI{366}{$\mu$V} and the quantization
error is \SI{\sim106}{$\mu$V}.

In normal operation, each pipelined \dword{adc} passes a 16-bit result to the
data formatter on the rising edge of the \SI{16}{MHz} clock.  The data formatter
separates the two 16-bit words into eight 4-bit nibbles and serializes the
nibbles for output (most significant bit first) at \SI{64}{MHz}.  An output
clock and a frame marker are also generated.  The frame marker indicates the most
significant bit in each nibble of the first of eight channels digitized by one
of the \dword{adc} pipelines in each \SI{2}{MHz} sample period.  The output data
is generated on the falling edge of the output clock and is latched by the
\dword{coldata} \dword{asic} using the rising edge of the same clock.  A second
mode of operation is included for debugging purposes.  In this mode, (2-bit) raw
stage results from each of the 15 stages of one of the two pipelines are formatted
into the most significant 15 bits of two 16-bit words, broken into nibbles, and
output in the same manner as normal data.

Ten differential output drivers are used for the \SI{64}{MHz} output clock, frame
marker, and \dword{adc} data.  The output drivers source and sink a current whose
value can be digitally controlled.  The minimum current is \SI{165}{$\mu$A},
which corresponds to approximately \SI{3}{mV} peak-to-peak with \SI{100}{$\Omega$}
termination.  Seven additional levels spaced by \SI{275}{$\mu$A} can be selected.
The maximum current is \SI{2.07}{mA}, about 2/3 of the LVDS standard of
\SI{3.5}{mA}.

The operation of \dword{coldadc} is controlled by a number of 8-bit registers.
These registers can be written to and read back using either an \dword{i2c}
interface or a UART.  \dword{coldata} will use the \dword{i2c} interface.  The
UART is included in the first \dword{coldadc} prototype to facilitate chip testing
and for risk mitigation.

Results of bench tests (and later system tests in \dword{lar}) will be included
when they are available.  These will include measurements of performance and
also power consumption.

%%%%%%%%%%%%%%%%%%
\subsubsection{COLDATA ASIC}
\label{sec:fdsp-tpcelec-design-femb-coldata}

The \dword{coldata} \dword{asic} was designed by engineers from \dword{fermilab} 
and Southern Methodist University. It is responsible for all communications 
between the \dwords{femb} and the electronics located outside the cryostat. 
Each \dword{femb} contains two \dword{coldata} chips. \dword{coldata} receives 
command and control information from a \dword{wib}. Each \dword{coldata} provides 
clocks to four \dword{coldadc}s and relays commands to four \dword{larasic} 
\dword{fe} \dwords{asic} and four \dword{coldadc}s to set operating modes and 
initiate calibration procedures.  Each \dword{coldata} receives data from four 
\dword{coldadc}s, merges the data streams, provides 8b/10b encoding, serializes 
the data, and transmits the data to the warm electronics over two \SI{1.28}{Gbps} 
links.  These links are driven by line drivers with programmable pre-emphasis. 
A block diagram of \dword{coldata} is shown in Figure~\ref{fig:coldata_block_diagram}.
The possibility of transmitting data from \dword{coldata} over a single 
\SI{2.56}{gbps} link will be investigated in 2019, with the goal of further
reducing the number of cold cables that need to be routed through the
\dword{apa} frame, as discussed in Section~\ref{sec:fdsp-tpcelec-interfaces-apa}

\begin{dunefigure}
[\dword{coldata} block diagram]
{fig:coldata_block_diagram}
{\dword{coldata} block diagram}
\includegraphics[width=1.0\linewidth]{sp-tpcelec-COLDATA-block-diagram.png}
\end{dunefigure}

The commands for the control of all the \dwords{asic} on a \dword{femb} are sent 
from \dword{wib} using an \dword{i2c}-like~\cite{i2c} protocol. While standard 
\dword{i2c} uses single ended \dword{cmos} signals and a bidirectional data 
line, because of the long cables required between the \dword{wiec} and the 
\dwords{femb}, \dword{coldata} uses low voltage differential pairs for both 
the \dword{i2c} clock and data. Point-to-point links are used and separate 
links are used for data sent from warm to cold and for data sent from cold to 
warm. In order to reduce the number of cables required, only one of the two 
\dword{coldata} chips on an \dword{femb} has its main \dword{i2c} interface 
directly connected to a \dword{wib}. That \dword{coldata} chip relays \dword{i2c} 
commands and data to the secondary \dword{coldata} chip and relays \dword{i2c} 
responses from the secondary \dword{coldata} to the \dword{wib}. Each 
\dword{coldata} also relays \dword{i2c} commands and data sent from the 
\dword{wib} to one of the four \dword{coldadc} chips associated with that 
\dword{coldata}, as well as data sent back to the \dword{wib} from one of the 
four \dword{coldadc} chips. The links on the \dword{femb} between \dword{coldata} 
chips and \dword{coldadc} chips use single-ended (\SI{2.25}{V}) \dword{cmos} 
signals, but the \dword{i2c} links are still non-standard as separate signals 
are used for data sent to the \dwords{coldadc} and data sent from the 
\dwords{coldadc} to \dword{coldata}.

The controls intended for the \dword{larasic} \dword{fe} chips are interpreted 
inside \dword{coldata} and transmitted to the appropriate \dword{asic} using 
a \dword{spi}-like interface that uses single-ended (\SI{1.8}{V}) \dword{cmos} 
signals. The configuration registers in \dword{larasic} are configured to be 
loaded as a single shift register. As data is shifted into \dword{larasic} on 
the \dword{mosi} line, bits from the other end of the shift register are shifted 
out on the \dword{miso} line. It is thus only possible to read \dword{larasic} 
configuration registers while writing new configuration data.

In addition to the configuration commands \dword{coldata} also receives from
the \dword{wib} a master clock and a fast command signal on a low voltage 
differential pair. Currently the master clock is \SI{64}{MHz}, but it will be
changed to \SI{62.5}{MHz} to simplify the overall \dword{dune} \dword{spmod} 
synchronization. The clock used for sampling the \dword{adc} is created inside
\dword{coldata} by dividing the master clock by 32. Both the master clock and
the \dword{adc} sampling clocks are passed from \dword{coldata} to the four
\dword{coldadc} chips that it controls. Depending on the master clock frequency
the \dword{adc} will convert input data every \num{500} or \SI{512}{ns}, 
corresponding to a frequency of \num{2} or \SI{1.95}{MHz}. The fast command 
line is used for signals that must be executed at a known time. \dword{coldata} 
uses the falling edge of the master clock to sample fast command bits as shown 
in Figure~\ref{fig:coldata_fast_command_timing}. All legal fast commands 
are \dword{dc} balanced. An ``alert'' pattern is used to establish the 8-bit 
fast command word boundary. An ``idle'' pattern is used when no command is being 
sent. Four commands are defined: ``Edge,'' which moves the rising edge of the 
\dword{adc} sampling clock to coincide with the next rising edge of the 
master MHz clock, ``Sync,'' which zeros the 8-bit timestamp that is the incremented 
on the rising edge of each \dword{adc} sampling clock, ``Reset,'' which resets 
\dword{coldata}, and ``ACT,'' the function of which is determined by an 8-bit 
register that is programmed using the \dword{i2c} interface.  

\begin{dunefigure}
[\dword{coldata} Fast Command Timing]
{fig:coldata_fast_command_timing}
{Fast command timing: the leading edges of the fast command and of the master 
clock are equal time when produced on the \dword{wib}. The fast command bits 
are captured by \dword{coldata} on the falling edge of the master clock and 
shifted into a register on the next positive edge.}
\includegraphics[width=0.4\linewidth]{sp-tpcelec-clocksandfastcommand.png}
\end{dunefigure}

\dword{coldata} receives digitized waveform data from 
four \dword{coldadc} \dwords{asic}. Each \dword{adc} presents its data on eight 
serial streams operating in parallel. Data from the \dwords{adc} is captured 
using the \dword{adc} dataClkOut (one per \dword{adc}) and the start of a 
sample period is indicated by the frameStart signal (one per \dword{adc}). 
Each \dword{adc} digitizes 16 channels of information and puts out 16 bits 
of data per channel. Information from two \dwords{adc} are merged by a Data 
Frame Formation block. The Data Frame Formation circuitry converts the two 
groups of 16 16-bits words into one of three types of data frame. For normal 
data taking, either a 12-bits format or a 14-bits \dword{adc} format can be 
selected, discarding either the four or two lowest order bits. When the 
12-bits format is selected, a data frame consists of an 8b/10b command 
character (K28.2) and an 8-bits time stamp, followed by 48 bytes of \dword{adc} 
data and two bytes of parity information. When the 14-bits format is selected, 
a data frame consists of an 8b/10b command character (K28.3) and an 8-bits time 
stamp, followed by 56 bytes of \dword{adc} data and two bytes of parity 
information. Two debugging frame formats are also defined. When the ``Frame-12 Test'' 
format is selected, a data frame consists of an 8b/10b command character 
(K28.0) and an 8-bits time stamp, followed by 48 bytes of predefined data 
and two bytes of parity information. The final format is used when the 
\dword{coldadc}s are read out in debug mode. In this case, 30 bits of raw 
pipeline stage data are read out from one of the two pipelined \dwords{adc} 
in each \dword{coldadc} \dword{asic} and passed from \dword{coldadc} to 
\dword{coldata} using two 16-bit frames. When the ``Frame-15'' format is 
selected, a \dword{coldata} output data frame consists of an 8b/10b command 
character (K28.6) and an 8-bit time stamp, followed by 60 bits of \dword{adc} 
data (30 bits from each \dword{coldadc}). No parity information is generated 
when this format is selected. This is to ensure that at least one idle 
character (K28.1) will be sent between each ``Frame-15.'' A series of 8b/10b 
command characters (K28.5) is sent at the end of each frame of 12-bits or 
14-bits data to ensure synchronization of the high speed links.

The serializers and output drivers use clocks derived from a micro-mechanical
system oscillator on the \dword{femb}. A single \dword{pll} generates a 
\SI{1.28}{GHz} clock for both serializers and output drivers. The 10-bits 
serializers are implemented using two 5:1 multiplexers (clocked at \SI{128}{MHz}) 
followed by a single 2:1 multiplexer (clocked at \SI{640}{MHz}). Each serializer 
derives the \SI{640}{MHz} and \SI{128}{MHz} clock from the \SI{1.28}{GHz} 
clock provided by the \dword{pll} and provides its \SI{128}{MHz} clock to 
the Data Frame Formation block, which uses it at the output stage of a 
clock-domain-crossing \dword{fifo}. A link synchronization sequence of 8b/10b 
command characters (K28.5) is used when the link is reset to establish the 
boundary between 10-bits ``words.'' Idle characters (K28.1) are inserted 
by the Data Frame Formation block when no data is ready for serialization 
(between data frames). The \SI{1.28}{Gbps} output drivers include programmable 
pre-emphasis. The pre-emphasis is achieved using a combination of a voltage 
mode circuit at the input to the current mode driver and current mode 
pre-emphasis integrated into the driver circuit. Measurements were made 
of the insertion loss (``S parameters'') as a function of frequency using
\num{25} and \SI{35}{m} lengths of the twinax cable identical to the 
cable used in \dword{pdsp}, and the output driver circuit including 
pre-emphasis was simulated using a \dword{spice} model based on these 
measurements. The simulated eye diagram after \SI{25}{m} of warm twinax 
cable is shown in Figure~\ref{fig:128Gbpseyesim}. The \dword{pll} and 
serializer circuits used in \dword{coldata} were included in the CDP1 
test chip which was produced in Fall 2017 and shown to work as designed. 
The pre-emphasis circuit has been added to the current mode driver which 
was verified in CDP1 and can be disabled if desired. 

\begin{dunefigure}
[\dword{coldata} output simulated eye diagram]
{fig:128Gbpseyesim}
{Simulated eye diagram after \SI{25}{m} of \dword{pdsp} twinax at room 
temperature for the \dword{coldata} \SI{1.28}{Gbps} output link.  
The eye diagram is more open at cryogenic temperature.}
\includegraphics[width=0.8\linewidth]{sp-tpcelec-128Gbpseyesim.png}
\end{dunefigure}

Both \dword{coldata} and \dword{coldadc} are implemented in the 
\dword{tsmc} \SI{65}{nm} \dword{cmos} process. The designs were 
done using cold transistor models produced by Logix Consulting~\cite{Logix}.
Logix made measurements of \dword{fnal}-supplied \dword{tsmc} 
\SI{65}{nm} transistors at LN2 temperature and extracted and provided 
to the design teams \dword{spice} models models valid at \lntwo 
temperature.  These models were used in analog simulations of 
\dword{coldata} and \dword{coldadc} subcircuits.  In order to 
eliminate the risk of accelerated aging due to the hot carrier 
effect~\cite{Hot-electron}, no transistor with channel length 
less than \SI{90}{nm} was used in either \dword{asic} design.  
A special library of standard cells using \SI{90}{nm} channel 
length transistors was developed by members of the University 
of Pennsylvania and \dword{fnal} groups. Timing parameters were 
developed for this standard cell library using the Cadence Liberate 
tool~\cite{Liberate} and the Logix \dword{spice} models. With the 
exception of the \dword{coldata} \dword{pll}, serializer, and 
output driver, the digital sections of \dword{coldata} and 
\dword{coldadc} were synthesized from Verilog code using this 
standard cell library and the Cadence Innovus tool~\cite{Innovus}.
Innovus was also used for the layout of the synthesized logic.




%citation dword{i2c}: http://i2c.info
%citation SPI: https://en.wikipedia.org/wiki/Serial_Peripheral_Interface
%citation TSMC65:  http://www.tsmc.com/english/dedicatedFoundry/technology/65nm.htm
%citation Logix: Logix Consulting™, http://www.lgx.com/
%citation SPICE: SPICE™ is a general-purpose circuit simulation program, https://bwrcs.eecs.berkeley.edu/Classes/IcBook/SPICE/
%citation Hot-electron: C. Hu, et al., ``Hot-electron induced MOSFET degradation-model, monitor, and improvement,” IEEE Trans. Electron Devices, vol ED-32, no. 2, pp 375-385, 1985.
%citation Liberate: https://www.cadence.com/content/cadence-www/global/en_US/home/tools/custom-ic-analog-rf-design/library-characterization/liberate-characterization.html
%citation Innovus: https://www.cadence.com/content/cadence-www/global/en_US/home/tools/digital-design-and-signoff/hierarchical-design-and-floorplanning/innovus-implementation-system.html

%%%%%%%%%
\subsubsubsection{CRYO Option}
\label{sec:fdsp-tpcelec-design-femb-alt-cryo}

The \dword{slac} \dword{cryo} \dword{asic} differs from the baseline three-chip design by combining the functions of an analog preamplifier, \dword{adc}, and data serialization and transmission for \num{64}~wire channels into a single chip.
It is based on a design developed for the nEXO experiment\footnote{Enriched Xenon Observatory, \url{https://www-project.slac.stanford.edu/exo/about.html}.} and differs from it only in the design of the preamplifier, which is modified for the higher capacitance of the \dword{dune} \dword{spmod} wires compared to the small pads of nEXO.
The \dwords{femb} constructed using this chip would use only two \dwords{asic}, compared to the \num{18} (eight~\dword{fe}, eight~\dword{adc} and two~\dword{coldata}) needed in the baseline design.
This drastic reduction in part count may significantly improve \dword{femb} reliability, reduce power, and reduce costs related to production and testing. 

Figure~\ref{fig:cryo-architecture} shows the overall architecture of the \dword{cryo} \dword{asic}, which will be implemented in \SI{130}{nm} \dword{cmos}.
It comprises two identical, \num{32}-channel blocks. 
The current signal from each wire is amplified using a preamplifier with pole zero cancellation and an anti-alias fifth-order Bessel filter. 
Provisions are also made for injection of test pulses. 
Gain and peaking time are adjustable to values similar to those of the baseline design.

\begin{dunefigure}
[Overall architecture of the CRYO \dword{asic}.]
{fig:cryo-architecture}
{Overall architecture of the CRYO \dword{asic}.}
\includegraphics[width=0.8\textwidth]{sp-tpcelec-cryo-schematic.png}
\end{dunefigure}

The \dword{adc} uses \SI{8}{MHz} \dword{sar}, so four input channels are multiplexed onto a single \dword{adc}. The data serialization and transmission block uses a custom 12b/14b encoder, so \num{32} channels of \num{12}-bit, \SI{{\sim}2}{MHz} data can be transmitted with a digital bandwidth of only \SI{896}{Mbps}, which is significantly less than the required bandwidth of the baseline, which is \SI{1.28}{Gbps}.

One key concern with mixed signal \dwords{asic} is the possibility of interference from the digital side causing noise on the very sensitive preamplifier. 
Fortunately, well established techniques for isolating substrate are described in the literature~\cite{yeh}, which have been successfully used in previous \dwords{asic} produced by the \dword{slac} group.% Figure \ref{fig:cryo-substrate} shows how substrate isolation is achieved. 

%\begin{dunefigure}
%[Depiction of the substrate isolation technique that allows combining analog and digital circuitry on the same CRYO \dword{asic}.]
%{fig:cryo-substrate}
%{Depiction of the substrate isolation technique that allows combining analog and digital circuitry on the same CRYO \dword{asic}.}
%\includegraphics[width=0.6\textwidth]{tpcelec-cryo_substrate.png}
%\end{dunefigure}

The infrastructure requirements for a \dword{cryo} \dword{asic}-based system are similar to those of the baseline option. However, in most cases, somewhat fewer resources are needed.
\begin{itemize}
\item{A single voltage is needed for the power supply. This is used to generate two supply voltages using internal voltage regulators.}
\item{The output digital bandwidth on each of the four lines in an \dword{femb} is \SI{896}{Mbps}. This is lower than the baseline option because of the custom 12b/14b encoder of the \dword{cryo} chip. }
\item{The warm interface is different. Only a single clock is needed (\SI{56}{MHz}), and the configuration protocol is the \dword{slac} \dword{asic} control interface (SACI)~\cite{SACI} rather than \dword{i2c}.} \fixme{SACI is not in the glossary.}
\end{itemize}

The first iteration of the \dword{cryo} \dword{asic} design was submitted to MOSIS \fixme{MOSIS is not in the glossary.} for fabrication in November 2018.  The first prototypes should arrive in January 2019. Simulation-based studies have already been performed; at \SI{0.8}{\micro\second} peaking time and an input capacitance of \SI{200}{pF} (similar to that expected in the \dword{dune} \dword{spmod}), the \dword{enc} is approximately \num{500}\,e$^-$.  This noise level is similar to that expected with the baseline \dword{fe} and \dword{adc} \dword{asic} design in \dword{lar} with the same input capacitance.  They will first be tested in an existing test stand at \dword{slac}.  Subsequent tests are planned for a small test \dword{tpc} at \dword{fermilab} and on an \dword{apa} in the \dword{pdsp} cold box; these test facilities are described in Section~\ref{sec:fdsp-tpcelec-qa-facilities}.

In February 2019, stand-alone tests of the \dword{cryo} \dword{asic} will begin. In addition to standard bringing up tests, measurements of noise (\dword{enc}), linearity (effective Nnumber of bits, or \dword{enob} for short), and bit-error rate will be performed. Figure~\ref{fig:cryo-results} shows placeholder plots of the type that will be produced in the initial stand-alone tests.

\begin{dunefigure}
[Results of stand-alone tests of the CRYO \dword{asic}.]
{fig:cryo-results}
{Results of stand-alone tests of the CRYO \dword{asic}.  The top row shows noise levels in \dword{enc} measured for each channel at room temperature (left) and liquid nitrogen temperature (right).  The bottom row shows the measured linearity for each channel in terms of \dword{enob}. }
\includegraphics[width=0.8\textwidth]{sp-tpcelec-cryo-results.png}
\end{dunefigure}

%%%%%%%%%
\subsubsubsection{Commercial off the Shelf ADC Option}
\label{sec:fdsp-tpcelec-design-femb-alt-cots}

The SBND collaboration has been exploring the \dword{cots} \dword{adc} option for the \dword{tpc} readout electronics development since Spring 2017~\cite{Chen:2018zic}. After a market survey, few candidate \dwords{adc} in \dword{sar} architecture were identified with 100\% cold yield. Since July 2017, a lifetime study plan was developed to evaluate \dword{cots} \dword{adc} in two different phases: exploratory and validation. The lifetime study focused on the %\dword{adi} 
\fixme{'adi' not in glossary. What is this? Anne} AD7274 implemented in TSMC 350nm \dword{cmos} technology given the optimum performance in cryogenic operation compared to other candidates.

During the exploratory phase, fresh samples of \dword{cots} \dword{adc} AD7274 were stressed with higher than nominal operation voltage, such as 5 V, while power consumption (current drawn) was monitored continuously. Periodically, the sample would be operated at nominal voltage (V$_{DD}$ = 2.5V and V$_{REF}$ = 1.8V) for a performance characterization test, where both DNL (Differential Non-Linearity) and INL (Integral Non-Linearity) \fixme{DNL and INL should probably go into the glossary.} were monitored and analyzed in addition to the current monitoring. Stress test results were used to extrapolate the lifetime of the \dword{cots} \dword{adc}. We determined that the current drop of 1\% on the V$_{DD}$ be used as the degradation criterion for the lifetime study. In the validation phase, more devices were tested following the develped criteria to collect more data to validate what was learned in the exploratory phase.

The lifetime projection of \dword{cots} \dword{adc} AD7274 from the stress test with V$_{DD} >$ 5V is shown in Figure~\ref{fig:cotsadc-lifetime}. With ADC7274 operated at 2.5V, which is lower than the nominal 3.6V for 350nm \dword{cmos} technology, the projected lifetime is more than than 10$^6$ years.

\begin{dunefigure}
[Lifetime projection of COTS ADC]
{fig:cotsadc-lifetime}
	{Lifetime projection of COTS ADC AD7274 from the stress test with V$_{DD} >$ 5V. The current drop of 1\% on the V$_{DD}$ is used as degradation criterion. With nominal operation voltage of 3.6V for 350nm \dword{cmos} technology, the lifetime is projected to be more than 100 years. For SBND and DUNE \dword{fd}, the AD7274 will be operated at 2.5V to add a further margin; the expected lifetime is more than 10$^6$ years.}
\includegraphics[width=0.8\linewidth]{sp-tpcelec-cotsadc-lifetime.pdf}
\end{dunefigure}

Based on the lifetime study of AD7274, an \dword{femb} with \dword{cots} \dword{adc} was developed and characterized for an SBND experiment. The integration test was carried out with 40\% \dword{apa} at \dword{bnl} and showed satisfactory noise performance in Figure~\ref{fig:cotsadc-fembenc}. The \dword{cots} \dword{adc} AD7274 serves as a backup solution for the \dword{dune} \dword{fd} \dword{tpc} readout electronics system. The current plan is to evaluate AD7274 \fixme{Check this please.} in the small \dword{tpc} \dword{iceberg} at \dword{fermilab}. Ten \dwords{femb} with \dword{cots} \dword{adc} are being produced and will be used to instrument \dword{iceberg} \dword{tpc} for system integration tests in early 2019. 

\begin{dunefigure}
[ENC measurement of FEMB with COTS ADC]
{fig:cotsadc-fembenc}
	{The ENC measurement of FEMB with COTS ADC mounted on 40\% APA at \dword{bnl}. The picture of FEMB is shown in the top left corner. The induction plane (4 m wire) has ENC $\sim$ 400$e^-$ with 1$\mu$s peaking time, and the collection plane (2.8 m wire) has ENC $\sim$ 330$e^-$ with 1$\mu$s peaking time.}
\includegraphics[width=0.99\linewidth]{sp-tpcelec-cotsadc-fembenc.pdf}
\end{dunefigure}

%%%%%%%%%%%%%%%%%%
\subsubsection{Procedure and Timeline for ASIC Selection}
\label{sec:fdsp-tpcelec-design-femb-selection}

We are currently pursuing two different \dword{asic} designs
and planning on qualifying the \dword{cots} \dword{adc} solution that will be used for the SBND experiment.
For the moment, we are planning to continue developing 
both the three \dword{asic} solution and  the \dword{cryo} \dword{asic}
for at least a second iteration before deciding which \dword{asic} solution to use to construct
the \dword{dune} \dword{sp} detector. This assumes that the \dwords{femb}
populated with the first set of prototypes of the two kinds of
\dwords{asic}, expected to become available in Spring 2019,
demonstrate a performance at least similar to that of the
boards used for the \dword{pdsp} detector. We plan, in Fall 2019, to review the results of the system tests
discussed in Section~\ref{sec:fdsp-tpcelec-qa}. We will also
review results from measurements of the component lifetimes,
discussed in Section~\ref{sec:fdsp-tpcelec-qa-reliability}. In this review,
we will also decide whether to change anything on the list
of requirements for the \dwords{asic} and to further develop
plans for the two solutions. We expect that the subsequent iteration
of the design, fabrication, and testing of the \dwords{asic} and
\dwords{femb} will take an additional twelve months. At
the end of this process, when results from standalone tests of the
\dwords{asic} and system tests of the \dwords{femb} are
available, we should be in position to decide which \dword{asic}
solution to adopt for constructing the \dword{dune} \dword{sp} detector.

We have not yet identified the exact criteria for the
\dword{asic} selection. Performance in system tests will obviously
be one criterion, but we will need to consider reliability issues (which could favor the single \dword{asic}
solution that requires \dwords{femb} with fewer connections), 
power density (which could be less favorable to the \dword{cryo} solution),
and the costs and resources required during constructing
and testing the \dwords{femb}. We plan to charge a committee
to draft a series of recommendations on how to select the
\dword{asic} and review the recommendations in Fall
2019, before deciding on the second cycle of design for
\dwords{asic} and \dwords{femb}. Once the second cycle of design
and testing is complete, these recommendations will be used by the
committee charged with the final design review to suggest a
preferred option for the \dword{asic} solution for 
constructing the \dword{dune} \dword{sp} detector. The recommendation of
the committee will then be passed to the \dword{dune} Executive Board,
which is tasked with the final \dword{asic} decision.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Infrastructure Inside the Cryostat}
\label{sec:fdsp-tpcelec-design-infrastructure}

Each \dword{femb} is enclosed in a mechanical \dword{ce} box to provide support, cable strain
relief, and control of gas argon bubbles in the \dword{lar} from the \dword{femb} attached to the lower \dword{apa}
(which could in principle lead to discharge of the \dword{hv} system).
The \dword{ce} box, illustrated in Figure~\ref{fig:ce-box}, is designed to make the electrical connection 
between the \dword{femb} and the \dword{apa} frame, as defined in Section~\ref{sec:fdsp-tpcelec-design-grounding}.
Mounting hardware inside the \dword{ce} box connects the ground plane of the \dword{femb} to the box casing.

\begin{dunefigure}
[Prototype \dword{ce} box used in \dword{pdsp}.]
{fig:ce-box}
{Prototype \dword{ce} box used in \dword{pdsp}.}
\includegraphics[width=0.45\linewidth]{sp-tpcelec-CEbox.png}
\end{dunefigure}

The \dword{ce} box casing is electrically connected to the \dword{apa} frame via the metal mounting hardware,
called the Omega bracket (not shown in Figure~\ref{fig:ce-box}), 
and the input amplifier circuits are connected to the \dword{cr} board, which also terminate to
ground at the \dword{apa} frame, as shown in Figure~\ref{fig:CR-board}.
As a backup, the casing is also connected to the \dword{apa} frame via a twisted conducting wire.

In addition to the \dword{ce} box and mounting hardware, cable trays for support and routing the cold cables will be installed in the 
cryostat. One set of cable trays, shown in Figure~\ref{fig:trays} (left column), will be attached to the upper \dword{apa} itself 
to hold the \dword{ce} and \dword{pd} cables. A different cable tray design, also shown in Figure~\ref{fig:trays} (right column), will support the \dword{ce} and \dword{pd} cables underneath the lower hanging \dword{apa}. A final set of cable trays will be installed inside the 
cryostat after the \dword{apa}s are fixed in their final location to support the cables as they are 
routed to the \dword{ce} and \dword{pd} feedthroughs.

\begin{dunefigure}
[Side and end views of mechanical supports for the \dword{ce} Boxes on the upper (left column) and lower (right column) \dword{apa}s. Shown are the APA cable trays in green and pink, the CE Boxes in dark gray, and the Omega brackets and mounting hardware between the CE Boxes and APA frame in light gray.  The CE cables are shown in blue; the PD cables are not shown.]
{fig:trays}
{Side and end views of mechanical supports for the \dword{ce} Boxes on the upper (left column) and lower (right column) \dword{apa}s. Shown are the APA cable trays in green and pink, the CE boxes in dark gray, and the Omega brackets and mounting hardware between the CE boxes and APA frame in light gray.  The CE cables are shown in blue; the PD cables are not shown.}
\includegraphics[width=0.38\linewidth]{sp-tpcelec-upper-tray2.png}
\hspace{5mm}
\includegraphics[width=0.25\linewidth]{sp-tpcelec-lower-tray2.png} \\
\includegraphics[width=0.32\linewidth]{sp-tpcelec-upper-tray1.png}
\hspace{5mm}
\includegraphics[width=0.4\linewidth]{sp-tpcelec-lower-tray1.png}
\end{dunefigure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Cold Electronics Feedthroughs}
\label{sec:fdsp-tpcelec-design-ft}

All cold cables originating inside the cryostat connect to the outside warm electronics through \dword{pcb} \fixme{Does this abbreviation need to be in the glossary ?}board \fdth{}s
installed in the signal flanges distributed along the cryostat roof.
The \dword{tpc} data rate per \dword{apa}, with an overall multiplexing factor of 32 and 80 $\sim$1~Gbps data channels per \dword{apa},
is sufficiently low that the \dword{lvds} signals can be driven over copper twin-axial transmission lines.
Additional transmission lines are available to distribute \dword{lvds} clock signals and I$^2$C control information,
which are transmitted at a lower bit rate.
Optical fiber is used externally from the \dwords{wib} on the signal flange to the \dword{daq} (see Chapter~\ref{ch:sp-daq}) and slow control systems (see Chapter~\ref{ch:sp-cisc}).

\begin{dunefigure}
[TPC \dword{ce} \fdth.]
{fig:tpcelec-signal-ft}
{TPC \dword{ce} \fdth. The \dwords{wib} are seen edge-on in the left panel and in an oblique side-view in the right panel, which also shows the warm crate for an \dword{spmod} %DUNE module 
in a cutaway view.}
\includegraphics[width=0.9\linewidth]{sp-tpcelec-signal-FT.pdf}
\end{dunefigure}

The design of the signal flange includes a four-way cross spool piece, separate \dword{pcb} \fdth{}s for the \dword{ce} and \dword{pds} cables, and
an attached crate for the \dword{tpc} warm electronics, as shown in Figure~\ref{fig:tpcelec-signal-ft}.
The wire bias voltage cables connect to standard \dword{shv} connectors machined directly into the \dword{ce} \fdth,
ensuring no electrical connection between the wire bias voltages and other signals passing through the signal flange.
Each \dword{ce} \fdth serves the bias, power, and digital I/O needs of one \dword{apa}.  

Data and control cable bundles send system clock and control signals from the 
signal flange to the \dword{femb} and stream the $\sim$\SI{1}{Gbps} high-speed data from the \dword{femb} to the signal flange.  Each \dword{femb} 
connects to a signal flange via one data cable bundle, leading to 20 bundles between one \dword{apa} and one flange.  Each data bundle contains 12 low-skew twin-axial cables with a drain wire 
to transmit the following differential signals:
\begin{itemize}
    \item four \SI{1.28}{Gbps} data (two from each \dword{coldata});
    \item two \SI{64}{MHz} clocks (one input to each \dword{coldata});
    \item two fast command lines (one input to each \dword{coldata});
    \item three I$^2$C-like control lines (clock, data-in, and data-out); and
    \item one multipurpose \dword{larasic} output (temperature, reference voltage, or analog test output).
\end{itemize}

The \dword{lv} power is passed from the signal flange to the \dword{femb} by bundles of
20AWG twisted-pair wires. Half the wires are power feeds; the others
are attached to the grounds of the input amplifier circuits, as described in Section~\ref{sec:fdsp-tpcelec-design-bias}.
For a single \dword{femb}, the resistance is measured to be  <\SI{30}{\milli\ohm} at room temperature or $<10$~m$\Omega$ at 
\dword{lar} temperature. Each \dword{apa} has a copper cross section of approximately %$80~\mathrm{mm}^2$ 
\SI{80}{mm$^2$} with a 
resistance <\SI{1.5}{\milli\ohm} at room temperature or $<0.5$~m$\Omega$ at \dword{lar} temperature.

The bias voltages are applied to the $X$-, $U$-, and $G$-plane wire layers, three \dword{fc} terminations, 
and an electron diverter, as shown in Figure~\ref{fig:CR-board}. The voltages are supplied 
through eight \dword{shv} connectors mounted on the signal flange. RG-316 coaxial cables carry the voltages 
from the signal flange to a patch panel \dword{pcb} that includes noise filtering mounted on the top 
end of the \dword{apa}. 

From there, wire bias voltages are carried by single wires to 
various points on the \dword{apa} frame, including the \dword{cr} boards, a small \dword{pcb} mounted on or near 
the patch panel that houses a noise filter and termination circuits for the field cage voltages, and 
a small mounted board near the electron diverter that also houses wire bias voltage filters.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Warm Interface Electronics}
\label{sec:fdsp-tpcelec-design-warm}

The warm interface electronics provide an interface between the \dword{ce}, \dword{daq}, timing, and slow control systems, including local power control at the flange and a real-time diagnostic readout. They are housed in the \dwords{wiec} attached directly to the \dword{ce} flange.  The \dword{wiec} shown in Figure~\ref{fig:tpcelec-flange} contains one power and timing card (\dword{ptc}), five warm interface boards (\dwords{wib}) and a passive power and timing backplane (PTB), which fans out signals and \dword{lv} power from the \dword{ptc} to the \dwords{wib}. The \dword{wiec} must provide Faraday-shielded housing, robust ground connections from the \dwords{wib} to the detector ground described in Section~\ref{sec:fdsp-tpcelec-design-grounding}, and only optical fiber links to the \dword{daq} and slow control to mitigate noise introduced at the \dword{ce} \fdth.

\begin{dunefigure}
[Exploded view of the \dword{ce} signal flange for \dword{pdsp}.]
{fig:tpcelec-flange}
{Exploded view of the \dword{ce} signal flange for \dword{pdsp}.  The design will be very similar for the \dword{spmod} \dword{ce} signal flange (with two \dword{ce} signal flanges per \fdth).}
\includegraphics[width=0.9\linewidth]{sp-tpcelec-flange.png}
\end{dunefigure}

The \dword{wib} is the interface between the \dword{daq} system and four
\dwords{femb}. It receives the system clock and control signals from the
timing system and provides processing and fan-out of those signals to the four
\dwords{femb}. The \dword{wib} also receives high-speed data signals from the four 
\dwords{femb} and transmits them to the \dword{daq} system over optical
fibers. The data signals are recovered onboard the \dword{wib} with commercial equalizers.
The \dwords{wib} are attached directly to the \dword{tpc}
\dword{ce} \fdth on the signal flange. The \fdth
board is a \dword{pcb} with connectors to the cold signal and \dword{lv} power cables fitted
between the compression plate on the cold side and sockets for
the \dword{wib} on the warm side. Cable strain relief for the cold cables is 
supported from the back end of the \fdth.

The \dword{pdsp} \dword{ptc} provides a bidirectional fiber interface to the
timing system. The clock and data
streams are separately fanned out to the five \dwords{wib} as shown in
Figure~\ref{fig:tpcelec-wib-timing}. The \dword{ptc} fans the clocks out to the \dword{wib} over the
PTB, which is a passive backplane attached directly to the \dword{ptc} and
\dwords{wib}.  The received clock on the \dword{wib} is separated into clock and
data using a clock-data separator. Timing endpoint firmware to receive and transmit
the clock is integrated into the \dword{wib} \dword{fpga} (the Altera Arria V\footnote{Altera Arria\texttrademark{}, V FPGA family, \url{https://www.altera.com/products/fpga/arria-series/arria-v/overview.html}.} was used for \dword{pdsp}).
The \dword{spmod} timing system, described in Section~\ref{sec:sp-daq:design-timing}, is a development of the \dword{pdsp} system and expected to require nearly identical functionality at the \dword{wib} endpoint.

\begin{dunefigure}
[\dword{pdsp} PTC and timing distribution to the \dword{wib} and FEMBs]
{fig:tpcelec-wib-timing}
{Power and timing card (\dword{ptc}) and timing distribution to the \dword{wib} and \dwords{femb} used in \dword{pdsp}.}
\includegraphics[width=0.75\linewidth]{sp-tpcelec-wib-timing-v2.pdf}
\end{dunefigure}

The \dword{ptc} also receives \SI{48}{V} \dword{lv} power for all cold
electronics connected through the \dword{tpc} signal flange: one \dword{ptc}, five \dwords{wib}, and \num{20}~\dwords{femb}. The \dword{lv} power is then stepped down
to \SI{12}{V} via a DC-DC converter onboard the \dword{ptc}. The output of the \dword{ptc} converters is filtered with a common-mode choke and fanned out
on the PTB to each \dword{wib}, which provides the necessary \SI{12}{V} DC-DC conversions and fans
the \dword{lv} power out to each of the cold \dwords{femb} supplied by that \dword{wib} 
as shown in Figure~\ref{fig:tpcelec-wib-power}. The output of the \dword{wib} converters is further filtered by a common-mode choke. Most of the power drawn by a full flange is dissipated in the \dword{lar} by the cold \dword{femb}.

\begin{dunefigure}
[\dword{pdsp} \dword{lv} power distribution to the \dword{wib} and \dwords{femb}]
{fig:tpcelec-wib-power}
{\dword{lv} power distribution to the \dword{wib} and \dwords{femb} implemented for \dword{pdsp}. This will be modified for the \dword{spmod} to provide the required voltage or voltages depending on which \dwords{asic} are used on the \dwords{femb}. In particular, the voltages to the \dword{femb} \numrange{0}{3} will change as the \dword{pdsp} \dword{fpga} is replaced by \dword{coldata}. }
\includegraphics[width=0.65\linewidth]{sp-tpcelec-wib-power.pdf}
\end{dunefigure}

Because the \dwords{wib} can provide local power to the \dword{femb} and real-time diagnostic readout of all channels,
each \dword{ce} system for each \dword{apa} is a complete, stand-alone readout unit. The \dwords{femb} and cold cables are shielded
inside the cryostat, and the \dwords{wib} and \dword{ptc} are shielded inside the Faraday cage of the warm interface
electronics crate, with only shielded power cables and optical fibers connecting to external systems.

As shown in Figure~\ref{fig:tpcelec-dune-wib}, the \dword{wib} can receive \dword{lv} power in the front panel and distribute it directly to the \dword{femb}, bypassing all DC/DC converters.
It can also receive the encoded system timing signals over bi-directional optical
fibers on the front panel and process them using either
the on-board \dword{fpga} or clock synthesizer chip to provide the clock required by the \dword{ce}.
The baseline \dword{asic} design currently uses 8b/10b encoding; if the \dword{slac} \dword{cryo} \dword{asic} is selected for
the \dword{dune} \dword{spmod}, 12b/14b encoding will be used instead of 8b/10b.

\begin{dunefigure}
[Warm interface board (\dword{wib})]
{fig:tpcelec-dune-wib}
{Warm interface board (\dword{wib}). Note that front panel inputs include a LEMO connector and alternate inputs for \dword{lv} power and timing.}
\includegraphics[width=0.8\linewidth]{sp-tpcelec-dune-wib.jpg}
\end{dunefigure}

The \dword{fpga} on the \dword{wib} will have
transceivers that can drive the high-speed data to the \dword{daq} system up to
10.3125~Gbps per link, indicating that all data from
two \dwords{femb} (2$\times$5~Gbps) could be transmitted on a single link.
The \dword{fpga} will have an additional Gbps ethernet transceiver I/O based on the \SI{125}{MHz} clock, which 
provides real-time digital data readout to the slow control system.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Services on Top of the Cryostat}
\label{sec:fdsp-tpcelec-design-services}

As implemented for \dword{pdsp}, a fully loaded \dword{wib} (one \dword{wib} plus four \dwords{femb}) requires
\SI{12}{V} and draws up to approximately \SI{4}{A}. The full electronics for one \dword{apa} (one \dword{ptc}, five \dwords{wib}, and \num{20} \dwords{femb}) 
requires \SI{12}{V} and draws approximately \SI{20}{A}, for a total power of approximately \SI{240}{W}, as 
described in Section~\ref{sec:fdsp-tpcelec-design-warm}. The \dword{spmod} implementation should require much 
less power because the \dword{fpga} will be replaced by the \dword{coldata} chips.

The \dword{lv} power is delivered at \SI{48}{V} to the \dword{ptc}, so each \dword{lv} power mainframe is chosen to bracket that value; each has  
roughly \numrange{30}{60}{V}, \SI{13.5}{A}, \SI{650}{W} maximum capacity per \dword{apa}. Using 10AWG cable, a \SI{0.8}{V} drop should occur along the cable with a required power of \SI{306}{W} out of \SI{650}{W} available.  
This leaves a significant margin for more distance between power supplies and 
the warm interface crates than the \SI{20}{\meter} in \dword{pdsp}.

Four wires are used for each module; two 10AWG, shielded, twisted-pair cables for the power and return; and two 20AWG, shielded, twisted-pair cables for the sense.
The primary protection is the over-current protection circuit in the \dword{lv} supply modules, 
which is set higher than the \SI{20}{A} current draw of the \dword{wiec}.  Secondary sense line fusing is 
provided on the \dword{ptc}.  The \dword{lv} power cable uses FCi micro TCA\footnote{MicroTCA\texttrademark{} (\dword{utca}) vertical card-edge connectors, Amphenol ICC,  \url{https://www.amphenol-icc.com/product-series/micro-tca-card-edge.html}.} connectors as shown in
Figure~\ref{fig:tpcelec-powerconn}.

% we can think about removing this figure
\begin{dunefigure}
[FCi microTCA power connector at the \dword{ptc} end of the cable.]
{fig:tpcelec-powerconn}
{FCi microTCA power connector at the \dword{ptc} end of the cable.}
\includegraphics[width=0.9\linewidth]{sp-tpcelec-power-connector.png}
\end{dunefigure}

An 18V linear power supply will provide power to the cooling fans for the WIEC \fixme{WIEC is not in the glossary. Should it be?}. It will be interlocked to the 48V power 
supplies, so the \dwords{wib} cannot be powered unless the cooling fans are operating. A 10V power supply will provide
power to the 4 heating elements on each \dword{pd} and \dword{ce} flange.

Bias voltages for the \dword{apa} wire planes, the electron diverters, and the last \dword{fc} electrodes are generated 
by supplies that are the responsibility of the \dword{tpc} electronics consortium.  The current from each of these supplies 
should be very close to zero in normal operation.  However, the ripple voltage must be carefully controlled to 
avoid injecting noise into the front-end electronics.  RG-58 coaxial cables connect the wire bias voltages from the 
mini-crate to the standard \dword{shv} connectors machined directly into the \dword{ce} \fdth, so the \dword{lv} power and data connectors do not have electrical connections to wire bias voltages.

Optical fibers are used for all connections between the \dwords{wiec}, which act as
Faraday-shielded boxes, and the \dword{daq} and slow control systems.  The \dword{wib} reports
its onboard temperature and the current draw from each \dword{femb} to the slow control system, while the
current draw for each \dword{apa} is monitored at the mainframe itself.

To support the electronics, fan, and heater power cables, as well as optical fibers on top of the cryostat, 
cable trays will be installed. Racks for all the necessary \dword{lv} supplies will be installed on a mezzanine
near the cryostat roof as shown in Figure~\ref{fig:cryostat-roof}.
In addition, patch panels will be installed on top of the cryostat to separate the data and timing optical fibers and gigE
cables going to the \dword{ptc} and \dwords{wib} from the long cable run to the \dword{daq}.

\begin{dunefigure}
[Services on top of the cryostat. The racks for the \dword{lv} power supplies are shown in blue.]
{fig:cryostat-roof}
{Services on top of the cryostat. The racks for the \dword{lv} power supplies are shown in blue.}
\includegraphics[width=0.9\linewidth]{sp-tpcelec-cryostat-top.png}
\end{dunefigure}
